<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Add jsPDF library in your <head> -->
    <title>Gridhrasi Assessment Scale - Complete System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-tab {
            min-width: 160px;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: #007bff;
            color: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #007bff;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .required {
            color: #dc3545;
        }

        .parameter-group {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .parameter-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .radio-option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .radio-option input[type="radio"] {
            margin-right: 8px;
            scale: 1.2;
        }

        .radio-option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            font-weight: 600;
        }

        .nidana-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .nidana-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nidana-item:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .nidana-item.checked {
            border-color: #28a745;
            background: #f8fff8;
        }

        .nidana-item input[type="checkbox"] {
            margin-right: 12px;
            scale: 1.3;
        }

        .examination-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        .exam-test {
            padding: 20px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exam-test h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .exam-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        /* Subdivision styles */
        .subdivision-container {
            margin-bottom: 20px;
        }
        
        .subdivision-section {
            background-color: #f0f7ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4a90e2;
        }
        
        .leg-options {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .leg-option {
            flex: 1;
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .leg-option h6 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .file-upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            background: #e3f2fd;
        }

        .file-upload-area.drag-over {
            border-color: #28a745;
            background: #f8fff8;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 6px;
            margin-top: 10px;
        }

        .uploaded-file img {
            max-width: 100px;
            max-height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .severity-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.2em;
            margin: 10px;
        }

        .minimal { background: #d4edda; color: #155724; }
        .mild { background: #fff3cd; color: #856404; }
        .moderate { background: #f8d7da; color: #721c24; }
        .severe { background: #d1ecf1; color: #0c5460; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .investigation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .investigation-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #17a2b8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .investigation-item h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .radio-option {
                min-width: auto;
            }
            
            .score-display {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .exam-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Gridhrasi Assessment Scale</h1>
            <p>Comprehensive Ayurvedic Diagnostic System for Sciatica Assessment</p>
            <p><em>By Dr. Prakash Kumbar - EVA College of Ayurved</em></p>
        </div>

        <div class="score-display">
            Total Score: <span id="totalScore">0</span> | Page: <span id="currentPageIndicator">1/7</span>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('patient-info')">1. Patient Info</button>
            <button class="nav-tab active" onclick="showTab('nidana')">2. Nidana</button>
            <button class="nav-tab active" onclick="showTab('symptoms')">3. Symptoms</button>
            <button class="nav-tab active" onclick="showTab('differential')">4. Differential</button>
            <button class="nav-tab active" onclick="showTab('examination')">5. Examination</button>
            <button class="nav-tab active" onclick="showTab('investigation')">6. Investigation</button>
            <button class="nav-tab active" onclick="showTab('results')">7. Results</button>
        </div>

        <!-- Page 1: Patient Information -->
        <div id="patient-info" class="tab-content active">
            <div class="form-section">
                <h3>üë§ Patient Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patientName">Patient Name <span class="required">*</span></label>
                        <input type="text" id="patientName" required>
                    </div>
                    <div class="form-group">
                        <label for="age">Age <span class="required">*</span></label>
                        <input type="number" id="age" min="1" max="120" required>
                    </div>
                    <div class="form-group">
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dob">
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender <span class="required">*</span></label>
                        <select id="gender" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="phoneNo">Phone Number</label>
                        <input type="tel" id="phoneNo">
                    </div>
                    <div class="form-group">
                        <label for="opdNo">OPD Number</label>
                        <input type="text" id="opdNo">
                    </div>
                    <div class="form-group">
                        <label for="ipdNo">IPD Number</label>
                        <input type="text" id="ipdNo">
                    </div>
                    <div class="form-group">
                        <label for="department">Department</label>
                        <select id="department">
                            <option value="">Select Department</option>
                            <option value="ayurveda">Ayurveda</option>
                            <option value="orthopedics">Orthopedics</option>
                            <option value="neurology">Neurology</option>
                            <option value="pain-management">Pain Management</option>
                            <option value="general-medicine">General Medicine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consultationDate">Date of Consultation <span class="required">*</span></label>
                        <input type="date" id="consultationDate" required>
                    </div>
                    <div class="form-group">
                        <label for="followUpDate">Follow-up Date</label>
                        <input type="date" id="followUpDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="chiefComplaint">Chief Complaint <span class="required">*</span></label>
                    <textarea id="chiefComplaint" rows="4" placeholder="Describe the primary symptoms and complaints..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="pastHistory">Past History</label>
                    <textarea id="pastHistory" rows="4" placeholder="Previous medical history, surgeries, medications, etc..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="additionalPoints">Additional Points</label>
                    <textarea id="additionalPoints" rows="3" placeholder="Any additional relevant information..."></textarea>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <div></div>
                <button class="btn btn-success" onclick="nextPage('nidana')">Next: Nidana Assessment ‚Üí</button>
            </div>
        </div>

        <!-- Page 2: Nidana Assessment -->
        <div id="nidana" class="tab-content">
            <div class="form-section">
                <h3>üéØ Nidana (Etiological Factor) Assessment</h3>
                <p><strong>Instructions:</strong> Check all applicable etiological factors present in the patient.</p>
                <div class="nidana-checklist" id="nidanaChecklist"></div>
                <div class="result-card">
                    <h4>Risk Factors Identified: <span id="nidanaCount">0</span>/12</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="nidanaProgress"></div>
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('patient-info')">‚Üê Previous: Patient Info</button>
                <button class="btn btn-success" onclick="nextPage('symptoms')">Next: Symptoms Assessment ‚Üí</button>
            </div>
        </div>

        <!-- Page 3: Symptoms Assessment -->
        <div id="symptoms" class="tab-content">
            <div class="form-section">
                <h3>üìã Comprehensive Symptom Assessment</h3>
                <div id="symptomParameters"></div>
                <div class="result-card">
                    <h4>Symptom Severity Score: <span id="symptomScore">0</span>/36</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="symptomProgress"></div>
                    </div>
                    <div id="symptomSeverity"></div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('nidana')">‚Üê Previous: Nidana</button>
                <button class="btn btn-success" onclick="nextPage('differential')">Next: Differential Diagnosis ‚Üí</button>
            </div>
        </div>

        <!-- Page 4: Differential Diagnosis -->
        <div id="differential" class="tab-content">
            <div class="form-section">
                <h3>üîç Differential Assessment: Vataja vs Vata-Kaphaja Gridhrasi</h3>
                <div id="differentialParameters"></div>
                <div class="result-card">
                    <h4>Differential Diagnosis Score:</h4>
                    <div id="differentialResult"></div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('symptoms')">‚Üê Previous: Symptoms</button>
                <button class="btn btn-success" onclick="nextPage('examination')">Next: Examination ‚Üí</button>
            </div>
        </div>

        <!-- Page 5: Examination -->
        <div id="examination" class="tab-content">
            <div class="form-section">
                <h3>ü©∫ Clinical Examination Findings</h3>
                <div class="examination-section" id="examinationTests"></div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('differential')">‚Üê Previous: Differential</button>
                <button class="btn btn-success" onclick="nextPage('investigation')">Next: Investigation ‚Üí</button>
            </div>
        </div>

        <!-- Page 6: Investigation -->
        <div id="investigation" class="tab-content">
            <div class="form-section">
                <h3>üî¨ Investigation Reports</h3>
                <p><strong>Instructions:</strong> Upload relevant investigation reports, images, or documents.</p>
                
                <div class="investigation-grid">
                    <div class="investigation-item">
                        <h4>üìä Laboratory Reports</h4>
                        <div class="file-upload-area" onclick="triggerFileUpload('labReports')" ondrop="handleFileDrop(event, 'labReports')" ondragover="handleDragOver(event)">
                            <p>üìÑ Click or drag files here</p>
                            <small>Supported: PDF, JPG, PNG, DOCX</small>
                            <input type="file" id="labReports" multiple accept=".pdf,.jpg,.jpeg,.png,.docx" style="display: none;" onchange="handleFileUpload(event, 'labReports')">
                        </div>
                        <div id="labReportsFiles"></div>
                    </div>

                    <div class="investigation-item">
                        <h4>ü¶¥ X-Ray Reports</h4>
                        <div class="file-upload-area" onclick="triggerFileUpload('xrayReports')" ondrop="handleFileDrop(event, 'xrayReports')" ondragover="handleDragOver(event)">
                            <p>ü©ª Click or drag X-ray files here</p>
                            <small>Supported: PDF, JPG, PNG, DICOM</small>
                            <input type="file" id="xrayReports" multiple accept=".pdf,.jpg,.jpeg,.png,.dcm" style="display: none;" onchange="handleFileUpload(event, 'xrayReports')">
                        </div>
                        <div id="xrayReportsFiles"></div>
                    </div>

                    <div class="investigation-item">
                        <h4>üß† MRI Reports</h4>
                        <div class="file-upload-area" onclick="triggerFileUpload('mriReports')" ondrop="handleFileDrop(event, 'mriReports')" ondragover="handleDragOver(event)">
                            <p>üî¨ Click or drag MRI files here</p>
                            <small>Supported: PDF, JPG, PNG, DICOM</small>
                            <input type="file" id="mriReports" multiple accept=".pdf,.jpg,.jpeg,.png,.dcm" style="display: none;" onchange="handleFileUpload(event, 'mriReports')">
                        </div>
                        <div id="mriReportsFiles"></div>
                    </div>

                    <div class="investigation-item">
                        <h4>‚ö° CT Scan Reports</h4>
                        <div class="file-upload-area" onclick="triggerFileUpload('ctReports')" ondrop="handleFileDrop(event, 'ctReports')" ondragover="handleDragOver(event)">
                            <p>üì∏ Click or drag CT scan files here</p>
                            <small>Supported: PDF, JPG, PNG, DICOM</small>
                            <input type="file" id="ctReports" multiple accept=".pdf,.jpg,.jpeg,.png,.dcm" style="display: none;" onchange="handleFileUpload(event, 'ctReports')">
                        </div>
                        <div id="ctReportsFiles"></div>
                    </div>

                    <div class="investigation-item">
                        <h4>üî¨ Other Reports</h4>
                        <div class="file-upload-area" onclick="triggerFileUpload('otherReports')" ondrop="handleFileDrop(event, 'otherReports')" ondragover="handleDragOver(event)">
                            <p>üìã Click or drag other files here</p>
                            <small>Supported: PDF, JPG, PNG, DOCX, XLS</small>
                            <input type="file" id="otherReports" multiple accept=".pdf,.jpg,.jpeg,.png,.docx,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event, 'otherReports')">
                        </div>
                        <div id="otherReportsFiles"></div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="investigationNotes">Investigation Notes</label>
                    <textarea id="investigationNotes" rows="4" placeholder="Additional notes about investigations, findings, interpretations..."></textarea>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('examination')">‚Üê Previous: Examination</button>
                <button class="btn btn-success" onclick="nextPage('results')">Next: Results ‚Üí</button>
            </div>
        </div>

        <!-- Page 7: Results -->
        <div id="results" class="tab-content">
            <div class="form-section">
                <h3>üìä Comprehensive Assessment Results</h3>
                <div id="resultsPatientInfo"></div>
                <div id="resultsNidana"></div>
                <div id="resultsSymptoms"></div>
                <div id="resultsDifferential"></div>
                <div id="resultsExamination"></div>
                <div id="resultsInvestigations"></div>
                <div id="resultsSummary"></div>
                <div id="finalResults"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="exportFullPDF()">üìë Export Full PDF</button>
                    <button class="btn btn-success" onclick="generateComprehensiveReport()">üìÑ Generate Complete Report</button>
                    <button class="btn btn-warning" onclick="exportAllData()">üíæ Export All Data</button>
                    <button class="btn btn-danger" onclick="resetAllAssessments()">üîÑ Reset All</button>
                    <button class="btn" onclick="printResults()">üñ®Ô∏è Print Report</button>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button class="btn" onclick="prevPage('investigation')">‚Üê Previous: Investigation</button>
                <div></div>
            </div>
        </div>
    </div>

    <script>
        // Assessment data structure
        let patientData = {
            personalInfo: {},
            nidana: {},
            symptoms: {},
            differential: {},
            examination: {},
            investigations: {
                files: {},
                notes: ''
            }
        };

        // Assessment parameters data
        const nidanaFactors = [
            {
                title: "Ati Vyayama (Excessive physical exertion)",
                description: "Heavy work, walking >10,000 steps/day, gym, long distance walking/running"
            },
            {
                title: "Ati Vahana (Excessive travel or riding)",
                description: "Daily bike/car rides >30 mins, jerky rides, long commutes"
            },
            {
                title: "Abhighata (Trauma or injury)",
                description: "Recent or old trauma to spine, hip, back; fall or impact injury"
            },
            {
                title: "Vishama Asana (Improper posture)",
                description: "Bad sitting habits, faulty posture, poor ergonomics during work"
            },
            {
                title: "Ativyayama (Overuse of limbs)",
                description: "Long-standing jobs, repeated bending/lifting, household chores with strain"
            },
            {
                title: "Dukha Shayana / Utkatasana",
                description: "Use of very soft or hard mattress, long sitting on floor, uncomfortable chairs"
            },
            {
                title: "Vata Prakopaka Ahara (Dry, cold, light food)",
                description: "Excess dry snacks, fasting, cold water, irregular meals"
            },
            {
                title: "Atyambupana (Excess cold water intake)",
                description: ">3L water/day, frequent cold water / beverages"
            },
            {
                title: "Daurbalya (Low muscular strength)",
                description: "Flabby muscles, low back strength, sedentary lifestyle"
            },
            {
                title: "MRI Diagnosis: Disc Prolapse/Herniation",
                description: "Confirmed bulging disc, nerve compression seen in MRI"
            },
            {
                title: "Lumbar spondylosis / canal stenosis",
                description: "Degenerative spine, confirmed by ortho/CT/MRI"
            },
            {
                title: "Past history of Gridhrasi (Sciatica)",
                description: "‚â•1 episode in past, history of recurrence"
            }
        ];

        const symptomParams = [
            {
                title: "Radiating Pain",
                ayurvedicCorrelation: "Toda / Ruja / Spandana",
                description: "Pain from lower back to foot (along sciatic nerve path)",
                options: ["Absent", "Mild, occasional", "Moderate, frequent", "Severe, continuous"]
            },
            {
                title: "Lower Back Pain",
                ayurvedicCorrelation: "Katishoola / Pristha Shoola",
                description: "Pain in the lumbar and sacral region",
                options: ["Absent", "Mild pain", "Moderate pain", "Severe disabling pain"]
            },
            {
                title: "Sciatic Path Pain (Sphik ‚Üí Pada) or (Pada ‚Üí Sphik)",
                ayurvedicCorrelation: "Sphik-purva to pada vedana or pada to sphik vvedna",
                description: "Pain sequence from buttocks to legs or from legs to buttocks",
                options: ["No spread", "Up to thigh", "Up to knee", "Extending to foot"]
            },
            {
                title: "Numbness / Tingling Sensation",
                ayurvedicCorrelation: "Suptata / Spandana",
                description: "Paresthesia (pins and needles sensation)",
                options: ["Absent", "Mild, occasional", "Moderate, disturbing", "Severe, persistent"]
            },
            {
                title: "Muscle Weakness",
                ayurvedicCorrelation: "Bala Hani / Gati Vikriti",
                description: "Weakness in leg; difficulty walking/lifting leg",
                options: ["None", "Mild weakness", "Moderate, with fatigue", "Severe, needs support"]
            },
            {
                title: "Foot Drop",
                ayurvedicCorrelation: "Pada Gamanam Dourbalya",
                description: "Inability to lift front part of foot",
                options: ["Absent", "Occasional dragging", "Frequent dragging", "Complete foot drop"]
            },
            {
                title: "Difficulty in Standing or Walking",
                ayurvedicCorrelation: "Vikruta Gamanam / Stambha",
                description: "Gait difficulty due to pain or weakness",
                options: ["Normal", "Mild discomfort", "Moderate difficulty", "Needs support / cannot walk"]
            },
            {
                title: "Pain Worsens with Cough/Sneeze",
                ayurvedicCorrelation: "Vata Prakopaka Nidana",
                description: "Indicative of nerve root compression",
                options: ["No change", "Slight aggravation", "Moderate aggravation", "Severe exacerbation"]
            },
            {
                title: "Positive Straight Leg Raise Test",
                ayurvedicCorrelation: "Lasika Duhkha (equiv.)",
                description: "Sciatic pain induced while raising leg supine",
                options: ["Negative", "Pain at 60¬∞‚Äì90¬∞", "Pain at 30¬∞‚Äì60¬∞", "Pain at <30¬∞"]
            },
            {
                title: "Burning / Electric Shock Sensation",
                ayurvedicCorrelation: "Toda / Teevra Vedana",
                description: "Neuropathic signs",
                options: ["Absent", "Mild occasional", "Frequent episodes", "Severe, constant"]
            },
            {
                title: "Limited Range of Motion (Spine / Hip / Leg)",
                ayurvedicCorrelation: "Stambha / Gati Hani",
                description: "Restricted movement due to stiffness/pain",
                options: ["Full ROM", "Slight restriction", "Moderate limitation", "Severe limitation"]
            },
            {
                title: "Laterality of Symptoms",
                ayurvedicCorrelation: "Eka Paksha Vedana",
                description: "One-sided pain distribution",
                options: ["Absent", "Bilateral", "Unilateral, mild", "Unilateral, severe"]
            }
        ];

        const differentialParams = [
            {
                title: "Pain Character",
                vataja: "Sharp, Piercing, Radiating, Spasmodic",
                vataKaphaja: "Dull, Heavy, Deep seated"
            },
            {
                title: "Pain Intensity",
                vataja: "Severe, Sudden onset",
                vataKaphaja: "Mild to moderate, Gradual"
            },
            {
                title: "Stiffness (Stambha)",
                vataja: "Mild Or absent",
                vataKaphaja: "Marked, Persistent"
            },
            {
                title: "Numbness (Supti)",
                vataja: "Less frequent",
                vataKaphaja: "More prominent"
            },
            {
                title: "Heaviness (Gaurava)",
                vataja: "Absent",
                vataKaphaja: "Significant"
            },
            {
                title: "Appetite (Agni)",
                vataja: "Irregular (Vishamagni)",
                vataKaphaja: "Low appetite (Mandagni)"
            },
            {
                title: "Bowel Habits",
                vataja: "Constipation, Dry stool",
                vataKaphaja: "Sluggish, Sticky stool"
            },
            {
                title: "Associated Ama Signs",
                vataja: "Absent",
                vataKaphaja: "Present (Coated Tongue, Heaviness, Indigestion)"
            },
            {
                title: "Skin Texture",
                vataja: "Dry, Rough",
                vataKaphaja: "Moist, Cold"
            },
            {
                title: "Response To Fomentation",
                vataja: "Quick Relief With Snehana/Swedana",
                vataKaphaja: "Relief Only After Deepana-Pachana + Swedana"
            },
            {
                title: "Energy Levels",
                vataja: "Variable, Sometimes Hyperactive",
                vataKaphaja: "Low, Lethargic"
            },
            {
                title: "Tongue Examination",
                vataja: "Dry, Thin, Cracked",
                vataKaphaja: "Coated, Thick, Moist"
            }
        ];

        const examinationTests = [
            {
                id: 'slr',
                title: 'Straight Leg Raise Test',
                description: 'Primary test for sciatic nerve tension',
                options: ['', 'Negative', 'Positive (60¬∞-90¬∞)', 'Positive (30¬∞-60¬∞)', 'Positive (<30¬∞)', 'Bilateral Positive'],
                hasSubdivisions: true,
                subdivisions: [
                    {
                        name: 'active',
                        title: 'Active SLR',
                        legs: ['left', 'right']
                    },
                    {
                        name: 'passive',
                        title: 'Passive SLR',
                        legs: ['left', 'right']
                    }
                ]
            },
            {
                id: 'crossedSlr',
                title: 'Crossed SLR Test',
                description: 'Tests for central disc herniation',
                options: ['', 'Negative', 'Positive', 'Bilateral Response']
            },
            {
                id: 'slumpTest',
                title: 'Slump Test',
                description: 'Neural tension test',
                options: ['', 'Negative', 'Positive', 'Partial Response']
            },
            {
                id: 'femoralStretch',
                title: 'Femoral Nerve Stretch Test',
                description: 'Tests L2-L4 nerve roots',
                options: ['', 'Negative', 'Positive', 'Equivocal']
            },
            {
                id: 'piriformis',
                title: 'Piriformis/FAIR Test',
                description: 'Tests for piriformis syndrome',
                options: ['', 'Negative', 'Positive', 'Partial Reproduction']
            },
            {
                id: 'neurological',
                title: 'Neurological Examination',
                description: 'Motor, sensory, and reflex testing',
                options: ['', 'Normal', 'Motor deficit', 'Sensory deficit', 'Reflex changes', 'Multiple deficits', 'Not performed']
            }
        ];

        // Initialize the application
        function init() {
            loadNidanaFactors();
            loadSymptomParams();
            loadDifferentialParams();
            loadExaminationTests();
            updateScores();
            
            // Set default consultation date to today
            document.getElementById('consultationDate').value = new Date().toISOString().split('T')[0];
        }

        function updateLocalStorage() {
            // Stub function to prevent errors
            // In future: localStorage.setItem("patientData", JSON.stringify(patientData));
        }


        // Navigation functions
        function showTab(tabName, el = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(button => button.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (el) el.classList.add('active');

            // Update page indicator
            const pageNumbers = {
                'patient-info': '1/7',
                'nidana': '2/7',
                'symptoms': '3/7',
                'differential': '4/7',
                'examination': '5/7',
                'investigation': '6/7',
                'results': '7/7'
            };
            document.getElementById('currentPageIndicator').textContent = pageNumbers[tabName] || '1/7';

            // Update results if results tab is shown
            if (tabName === 'results') updateFinalResults();
            if (tabName !== 'patient-info') savePatientInfo();
        }

        function nextPage(targetPage) {
            showTab(targetPage);
        }

        function prevPage(targetPage) {
            showTab(targetPage);
        }

        // Patient Information functions
        function savePatientInfo() {
            const fields = [
                'patientName', 'age', 'dob', 'gender', 'phoneNo', 'opdNo', 'ipdNo',
                'department', 'consultationDate', 'followUpDate', 'chiefComplaint',
                'pastHistory', 'additionalPoints'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    patientData.personalInfo[field] = element.value;
                }
            });
        }

        // Nidana Assessment functions
        function loadNidanaFactors() {
            const container = document.getElementById('nidanaChecklist');
            container.innerHTML = '';

            nidanaFactors.forEach((factor, index) => {
                const div = document.createElement('div');
                div.className = 'nidana-item';
                div.onclick = () => toggleNidana(index);
                div.innerHTML = `
                    <input type="checkbox" id="nidana_${index}" onchange="toggleNidana(${index})">
                    <div>
                        <strong>${factor.title}</strong><br>
                        <small>${factor.description}</small>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleNidana(index) {
            const checkbox = document.getElementById(`nidana_${index}`);
            const item = checkbox.closest('.nidana-item');
            
            if (checkbox.checked) {
                patientData.nidana[index] = true;
                item.classList.add('checked');
            } else {
                delete patientData.nidana[index];
                item.classList.remove('checked');
            }
            updateNidanaResults();
        }

        function updateNidanaResults() {
            const count = Object.keys(patientData.nidana).length;
            document.getElementById('nidanaCount').textContent = count;
            
            const percentage = (count / 12) * 100;
            document.getElementById('nidanaProgress').style.width = `${percentage}%`;
        }

        // Symptoms Assessment functions
        function loadSymptomParams() {
            const container = document.getElementById('symptomParameters');
            container.innerHTML = '';

            symptomParams.forEach((param, index) => {
                const div = document.createElement('div');
                div.className = 'parameter-group';
                div.innerHTML = `
                    <div class="parameter-title">
                        ${param.title}
                        <div style="font-size: 0.9em; color: #666; font-weight: normal;">
                            <em>${param.ayurvedicCorrelation}</em> - ${param.description}
                        </div>
                    </div>
                    <div class="radio-group">
                        ${param.options.map((option, optIndex) => `
                            <label class="radio-option" onclick="selectSymptom(${index}, ${optIndex})">
                                <input type="radio" name="symptom_${index}" value="${optIndex}">
                                <div>
                                    <strong>Score ${optIndex}:</strong><br>
                                    ${option}
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectSymptom(paramIndex, score) {
            patientData.symptoms[paramIndex] = score;
            updateSymptomUI(paramIndex, score);
            updateSymptomResults();
        }

        function updateSymptomUI(paramIndex, selectedScore) {
            const radioOptions = document.querySelectorAll(`input[name="symptom_${paramIndex}"]`);
            radioOptions.forEach(radio => {
                const option = radio.closest('.radio-option');
                if (parseInt(radio.value) === selectedScore) {
                    option.classList.add('selected');
                    radio.checked = true;
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function updateSymptomResults() {
            const totalScore = Object.values(patientData.symptoms).reduce((sum, score) => sum + score, 0);
            document.getElementById('symptomScore').textContent = totalScore;
            
            const percentage = (totalScore / 36) * 100;
            document.getElementById('symptomProgress').style.width = `${percentage}%`;
            
            let severity = '';
            let severityClass = '';
            
            if (totalScore <= 10) {
                severity = 'Minimal or No Sciatica';
                severityClass = 'minimal';
            } else if (totalScore <= 20) {
                severity = 'Mild Gridhrasi';
                severityClass = 'mild';
            } else if (totalScore <= 30) {
                severity = 'Moderate Gridhrasi';
                severityClass = 'moderate';
            } else {
                severity = 'Severe Gridhrasi';
                severityClass = 'severe';
            }
            
            document.getElementById('symptomSeverity').innerHTML = `
                <div class="severity-badge ${severityClass}">${severity}</div>
            `;
        }

        // Differential Assessment functions
        function loadDifferentialParams() {
            const container = document.getElementById('differentialParameters');
            container.innerHTML = '';

            differentialParams.forEach((param, index) => {
                const div = document.createElement('div');
                div.className = 'parameter-group';
                div.innerHTML = `
                    <div class="parameter-title">${param.title}</div>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectDifferential(${index}, 'vataja')">
                            <input type="radio" name="diff_${index}" value="vataja">
                            <div>
                                <strong>Vataja:</strong><br>
                                ${param.vataja}
                            </div>
                        </label>
                        <label class="radio-option" onclick="selectDifferential(${index}, 'both')">
                            <input type="radio" name="diff_${index}" value="both">
                            <div>
                                <strong>Both Present:</strong><br>
                                Mixed presentation
                            </div>
                        </label>
                        <label class="radio-option" onclick="selectDifferential(${index}, 'vataKaphaja')">
                            <input type="radio" name="diff_${index}" value="vataKaphaja">
                            <div>
                                <strong>Vata-Kaphaja:</strong><br>
                                ${param.vataKaphaja}
                            </div>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectDifferential(paramIndex, value) {
            patientData.differential[paramIndex] = value;
            updateDifferentialUI(paramIndex, value);
            updateDifferentialResults();
        }

        function updateDifferentialUI(paramIndex, selectedValue) {
            const radioOptions = document.querySelectorAll(`input[name="diff_${paramIndex}"]`);
            radioOptions.forEach(radio => {
                const option = radio.closest('.radio-option');
                if (radio.value === selectedValue) {
                    option.classList.add('selected');
                    radio.checked = true;
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function updateDifferentialResults() {
            let vatajaScore = 0;
            let vataKaphajaScore = 0;

            Object.values(patientData.differential).forEach(value => {
                if (value === 'vataja') {
                    vatajaScore += 2;
                } else if (value === 'vataKaphaja') {
                    vataKaphajaScore += 2;
                } else if (value === 'both') {
                    vatajaScore += 1;
                    vataKaphajaScore += 1;
                }
            });

            const resultDiv = document.getElementById('differentialResult');
            let diagnosis = '';
            if (vatajaScore > vataKaphajaScore) {
                diagnosis = `<div class="severity-badge mild">Vataja Gridhrasi Predominant</div>`;
            } else if (vataKaphajaScore > vatajaScore) {
                diagnosis = `<div class="severity-badge moderate">Vata-Kaphaja Gridhrasi Predominant</div>`;
            } else {
                diagnosis = `<div class="severity-badge minimal">Mixed Presentation</div>`;
            }

            resultDiv.innerHTML = `
                <p>Vataja Score: <strong>${vatajaScore}</strong> | Vata-Kaphaja Score: <strong>${vataKaphajaScore}</strong></p>
                ${diagnosis}
            `;
        }

        // Examination functions
        function loadExaminationTests() {
            const container = document.getElementById('examinationTests');
            container.innerHTML = '';

            examinationTests.forEach((test, index) => {
                const div = document.createElement('div');
                div.className = 'exam-test';
                
                if (test.hasSubdivisions) {
                    // For tests with subdivisions (like SLR)
                    div.innerHTML = `
                        <h4>${test.title}</h4>
                        <p style="color: #666; margin-bottom: 15px;">${test.description}</p>
                        <div class="subdivision-container" id="${test.id}_subdivisions">
                            ${test.subdivisions.map(subdivision => `
                                <div class="subdivision-section" id="${test.id}_${subdivision.name}_section">
                                    <h5>${subdivision.title}</h5>
                                    <div class="leg-options">
                                        ${subdivision.legs.map(leg => `
                                            <div class="leg-option">
                                                <h6>${leg.charAt(0).toUpperCase() + leg.slice(1)} Leg</h6>
                                                <div class="form-group">
                                                    <label for="${test.id}_${subdivision.name}_${leg}">Result:</label>
                                                    <select id="${test.id}_${subdivision.name}_${leg}" onchange="saveSubdivisionResult('${test.id}', '${subdivision.name}', '${leg}')">
                                                        ${test.options.map(option => `<option value="${option}">${option || 'Select result'}</option>`).join('')}
                                                    </select>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="form-group">
                            <label for="${test.id}_image">Upload Image:</label>
                            <div class="file-upload-area" onclick="triggerFileUpload('${test.id}_image')" ondrop="handleFileDrop(event, '${test.id}_image')" ondragover="handleDragOver(event)">
                                <p>üì∑ Click or drag image here</p>
                                <small>JPG, PNG, PDF supported</small>
                                <input type="file" id="${test.id}_image" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handleFileUpload(event, '${test.id}_image')">
                            </div>
                            <div id="${test.id}_imageFiles"></div>
                        </div>
                        <div class="form-group">
                            <label for="${test.id}_notes">Additional Notes:</label>
                            <textarea id="${test.id}_notes" rows="2" placeholder="Any additional observations or notes..." onchange="saveExamNotes('${test.id}')"></textarea>
                        </div>
                    `;
                } else {
                    // For regular tests without subdivisions
                    div.innerHTML = `
                        <h4>${test.title}</h4>
                        <p style="color: #666; margin-bottom: 15px;">${test.description}</p>
                        <div class="exam-controls">
                            <div class="form-group">
                                <label for="${test.id}">Test Result:</label>
                                <select id="${test.id}" onchange="saveExamResult('${test.id}')">
                                    ${test.options.map(option => `<option value="${option}">${option || 'Select result'}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="${test.id}_image">Upload Image:</label>
                                <div class="file-upload-area" onclick="triggerFileUpload('${test.id}_image')" ondrop="handleFileDrop(event, '${test.id}_image')" ondragover="handleDragOver(event)">
                                    <p>üì∑ Click or drag image here</p>
                                    <small>JPG, PNG, PDF supported</small>
                                    <input type="file" id="${test.id}_image" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" onchange="handleFileUpload(event, '${test.id}_image')">
                                </div>
                                <div id="${test.id}_imageFiles"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="${test.id}_notes">Additional Notes:</label>
                            <textarea id="${test.id}_notes" rows="2" placeholder="Any additional observations or notes..." onchange="saveExamNotes('${test.id}')"></textarea>
                        </div>
                    `;
                }
                container.appendChild(div);
            });
        }

        function saveExamResult(testId) {
            const result = document.getElementById(testId).value;
            if (!patientData.examination[testId]) {
                patientData.examination[testId] = {};
            }
            patientData.examination[testId].result = result;
            updateLocalStorage();
        }
        
        function saveSubdivisionResult(testId, subdivisionName, leg) {
            const select = document.getElementById(`${testId}_${subdivisionName}_${leg}`);
            if (!select) return;
            
            if (!patientData.examination) {
                patientData.examination = {};
            }
            
            if (!patientData.examination[testId]) {
                patientData.examination[testId] = {};
            }
            
            if (!patientData.examination[testId][subdivisionName]) {
                patientData.examination[testId][subdivisionName] = {};
            }
            
            patientData.examination[testId][subdivisionName][leg] = select.value;
            updateLocalStorage();
        }

        function saveExamNotes(testId) {
            const notes = document.getElementById(testId + '_notes').value;
            if (!patientData.examination[testId]) {
                patientData.examination[testId] = {};
            }
            patientData.examination[testId].notes = notes;
            updateLocalStorage();
        }

        // File handling functions
        function triggerFileUpload(inputId) {
            document.getElementById(inputId).click();
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleFileDrop(event, inputId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            handleFiles(files, inputId);
        }

        function handleFileUpload(event, inputId) {
            const files = event.target.files;
            handleFiles(files, inputId);
        }

        function handleFiles(files, inputId) {
            const container = document.getElementById(inputId + 'Files') || document.getElementById(inputId.replace('_image', '_imageFiles'));
            
            Array.from(files).forEach(file => {
                if (validateFile(file, inputId)) {
                    displayUploadedFile(file, container, inputId);
                    saveFileToData(file, inputId);
                }
            });
        }

        function validateFile(file, inputId) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (file.size > maxSize) {
                alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                return false;
            }
            
            const allowedTypes = {
                'image': ['image/jpeg', 'image/png', 'application/pdf'],
                'document': ['application/pdf', 'image/jpeg', 'image/png', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet']
            };
            
            const category = inputId.includes('image') ? 'image' : 'document';
            if (!allowedTypes[category].includes(file.type)) {
                alert(`File type "${file.type}" is not supported for this field.`);
                return false;
            }
            
            return true;
        }

        function displayUploadedFile(file, container, inputId) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            
            const isImage = file.type.startsWith('image/');
            const filePreview = isImage ? 
                `<img src="${URL.createObjectURL(file)}" alt="Preview">` : 
                `<span>üìÑ ${file.name}</span>`;
            
            fileDiv.innerHTML = `
                ${filePreview}
                <div>
                    <strong>${file.name}</strong><br>
                    <small>${(file.size / 1024).toFixed(1)} KB</small>
                </div>
                <button class="btn btn-danger" onclick="removeFile(this, '${inputId}', '${file.name}')" style="padding: 5px 10px; margin: 0;">√ó</button>
            `;
            
            container.appendChild(fileDiv);
        }

        function saveFileToData(file, inputId) {
            if (!patientData.investigations.files[inputId]) {
                patientData.investigations.files[inputId] = [];
            }
            
            // Store file metadata (in real application, you'd upload to server)
            patientData.investigations.files[inputId].push({
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
            });
        }

        function removeFile(button, inputId, fileName) {
            button.parentElement.remove();
            
            // Remove from data
            if (patientData.investigations.files[inputId]) {
                patientData.investigations.files[inputId] = patientData.investigations.files[inputId].filter(
                    f => f.name !== fileName
                );
            }
        }

        // Scoring and results functions
        function updateFinalResults() {
            // 1) Patient Info
            let infoHtml = "<h4>Patient Information</h4><ul>";
            for (const [key, value] of Object.entries(patientData.personalInfo)) {
                if (value) infoHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            infoHtml += "</ul>";
            document.getElementById("resultsPatientInfo").innerHTML = infoHtml;

            // 2) Nidana
            const selectedNidana = Object.keys(patientData.nidana)
                .filter(i => patientData.nidana[i])
                .map(i => nidanaFactors[i].title);
            let nidanaHtml = "<h4>Nidana Factors</h4>";
            nidanaHtml += selectedNidana.length ? `<ul>${selectedNidana.map(n => `<li>${n}</li>`).join("")}</ul>` : "<p>None selected</p>";
            document.getElementById("resultsNidana").innerHTML = nidanaHtml;

            // 3) Symptoms
            let totalScore = 0;
            let symptomHtml = "<h4>Symptoms Assessment</h4><table><tr><th>Symptom</th><th>Score</th></tr>";
            Object.entries(patientData.symptoms).forEach(([i, score]) => {
                const title = symptomParams[i]?.title || `Symptom ${i}`;
                symptomHtml += `<tr><td>${title}</td><td>${score}</td></tr>`;
                totalScore += score;
            });
            symptomHtml += `</table><p><strong>Total Score:</strong> ${totalScore}/36</p>`;
            document.getElementById("resultsSymptoms").innerHTML = symptomHtml;

            // 4) Differential
            let diffHtml = "<h4>Differential Diagnosis</h4><ul>";
            Object.entries(patientData.differential).forEach(([i, val]) => {
                const title = differentialParams[i]?.title || `Param ${i}`;
                diffHtml += `<li>${title}: ${val}</li>`;
            });
            diffHtml += "</ul>";
            document.getElementById("resultsDifferential").innerHTML = diffHtml;

            // 5) Examination
            let examHtml = "<h4>Examination Findings</h4><ul>";
            Object.entries(patientData.examination).forEach(([testId, testData]) => {
                if (testData.hasSubdivisions) {
                    Object.entries(testData).forEach(([subName, subVal]) => {
                        if (typeof subVal === "object") {
                            Object.entries(subVal).forEach(([leg, result]) => {
                                examHtml += `<li>${testId} - ${subName} (${leg}): ${result || "N/A"}</li>`;
                            });
                        }
                    });
                } else {
                    examHtml += `<li>${testId}: ${testData.result || "N/A"}</li>`;
                }
                if (testData.notes) examHtml += `<li><em>Notes:</em> ${testData.notes}</li>`;
            });
            examHtml += "</ul>";
            document.getElementById("resultsExamination").innerHTML = examHtml;

            // 6) Investigations
            let invHtml = "<h4>Investigations</h4>";
            invHtml += `<p><strong>Notes:</strong> ${patientData.investigations.notes || "None"}</p>`;
            const files = [];
            Object.entries(patientData.investigations.files).forEach(([key, arr]) => {
                arr.forEach(f => files.push(f.name));
            });
            invHtml += `<p><strong>Files:</strong> ${files.length ? files.join(", ") : "None"}</p>`;
            document.getElementById("resultsInvestigations").innerHTML = invHtml;

            // 7) Clinical Summary
            let summaryHtml = "<h4>Clinical Summary</h4>";
            summaryHtml += document.getElementById("finalResults")?.innerText || "Not available";
            document.getElementById("resultsSummary").innerHTML = summaryHtml;
        }

        function getExaminationSummary() {
            let completed = 0;
            let total = 0;
            
            examinationTests.forEach(test => {
                if (test.hasSubdivisions) {
                    // For tests with subdivisions like SLR
                    test.subdivisions.forEach(subdivision => {
                        subdivision.legs.forEach(leg => {
                            total++;
                            if (patientData.examination[test.id] && 
                                patientData.examination[test.id][subdivision.name] && 
                                patientData.examination[test.id][subdivision.name][leg]) {
                                completed++;
                            }
                        });
                    });
                } else {
                    // For regular tests
                    total++;
                    if (patientData.examination[test.id] && patientData.examination[test.id].result) {
                        completed++;
                    }
                }
            });
            return `${completed}/${total}`;
        }

        function getKeyFindings() {
            const positiveFindings = [];
            
            examinationTests.forEach(test => {
                if (test.hasSubdivisions) {
                    // For tests with subdivisions like SLR
                    let hasPositiveResult = false;
                    let positiveDetails = [];
                    
                    test.subdivisions.forEach(subdivision => {
                        subdivision.legs.forEach(leg => {
                            if (patientData.examination[test.id] && 
                                patientData.examination[test.id][subdivision.name] && 
                                patientData.examination[test.id][subdivision.name][leg]) {
                                    
                                const result = patientData.examination[test.id][subdivision.name][leg];
                                if (result.includes('Positive') || result.includes('Multiple') || result.includes('deficit')) {
                                    hasPositiveResult = true;
                                    positiveDetails.push(`${subdivision.name} (${leg})`);
                                }
                            }
                        });
                    });
                    
                    if (hasPositiveResult) {
                        positiveFindings.push(`${test.title}: ${positiveDetails.join(', ')}`);
                    }
                } else {
                    // For regular tests
                    const exam = patientData.examination[test.id];
                    if (exam && exam.result && (exam.result.includes('Positive') || exam.result.includes('Multiple') || exam.result.includes('deficit'))) {
                        positiveFindings.push(test.title);
                    }
                }
            });
            
            return positiveFindings.length > 0 ? positiveFindings.join(', ') : 'No significant findings';
        }

        function getTotalFilesUploaded() {
            let total = 0;
            Object.values(patientData.investigations.files).forEach(fileArray => {
                if (Array.isArray(fileArray)) {
                    total += fileArray.length;
                }
            });
            return total;
        }

        function getInvestigationCategories() {
            const categories = [];
            const categoryMap = {
                'labReports': 'Lab Reports',
                'xrayReports': 'X-Ray',
                'mriReports': 'MRI',
                'ctReports': 'CT Scan',
                'otherReports': 'Others'
            };
            
            Object.keys(patientData.investigations.files).forEach(key => {
                const baseKey = key.replace('_image', '');
                if (patientData.investigations.files[key] && patientData.investigations.files[key].length > 0) {
                    const category = categoryMap[baseKey] || baseKey;
                    if (!categories.includes(category)) {
                        categories.push(category);
                    }
                }
            });
            
            return categories.length > 0 ? categories.join(', ') : 'None';
        }

       /*
        // Report generation functions
        function generateComprehensiveReport() {
            savePatientInfo();
            const investigationNotes = document.getElementById('investigationNotes').value;
            patientData.investigations.notes = investigationNotes;

            const currentDate = new Date().toLocaleDateString();
            const symptomScore = Object.values(patientData.symptoms).reduce((sum, score) => sum + score, 0);
            const nidanaCount = Object.keys(patientData.nidana).length;
            
            let vatajaScore = 0;
            let vataKaphajaScore = 0;
            Object.values(patientData.differential).forEach(value => {
                if (value === 'vataja') vatajaScore += 2;
                else if (value === 'vataKaphaja') vataKaphajaScore += 2;
                else if (value === 'both') { vatajaScore += 1; vataKaphajaScore += 1; }
            });

            let diagnosis = '';
            if (vatajaScore > vataKaphajaScore) {
                diagnosis = 'Vataja Gridhrasi Predominant';
            } else if (vataKaphajaScore > vatajaScore) {
                diagnosis = 'Vata-Kaphaja Gridhrasi Predominant';
            } else {
                diagnosis = 'Mixed Presentation';
            }

            let severity = '';
            if (symptomScore <= 10) severity = 'Minimal or No Sciatica';
            else if (symptomScore <= 20) severity = 'Mild Gridhrasi';
            else if (symptomScore <= 30) severity = 'Moderate Gridhrasi';
            else severity = 'Severe Gridhrasi';

            const report = `
COMPREHENSIVE GRIDHRASI ASSESSMENT REPORT
Generated on: ${currentDate}
Assessment Tool by: Dr. Prakash Kumbar, EVA College of Ayurved

=====================================
PATIENT INFORMATION:
=====================================
Name: ${patientData.personalInfo.patientName || 'Not specified'}
Age: ${patientData.personalInfo.age || 'Not specified'}
Gender: ${patientData.personalInfo.gender || 'Not specified'}
Date of Birth: ${patientData.personalInfo.dob || 'Not specified'}
Phone: ${patientData.personalInfo.phoneNo || 'Not specified'}
OPD No.: ${patientData.personalInfo.opdNo || 'Not specified'}
IPD No.: ${patientData.personalInfo.ipdNo || 'Not specified'}
Department: ${patientData.personalInfo.department || 'Not specified'}
Consultation Date: ${patientData.personalInfo.consultationDate || 'Not specified'}
Follow-up Date: ${patientData.personalInfo.followUpDate || 'Not specified'}

Chief Complaint:
${patientData.personalInfo.chiefComplaint || 'Not specified'}

Past History:
${patientData.personalInfo.pastHistory || 'Not specified'}

Additional Points:
${patientData.personalInfo.additionalPoints || 'Not specified'}

=====================================
ASSESSMENT RESULTS:
=====================================

1. SYMPTOM SEVERITY ASSESSMENT:
   - Total Score: ${symptomScore}/36
   - Severity Grade: ${severity}
   
2. DIFFERENTIAL DIAGNOSIS:
   - Vataja Score: ${vatajaScore}
   - Vata-Kaphaja Score: ${vataKaphajaScore}
   - Primary Diagnosis: ${diagnosis}
   
3. ETIOLOGICAL FACTORS (NIDANA):
   - Risk Factors Present: ${nidanaCount}/12
   - Risk Level: ${nidanaCount >= 8 ? 'High' : nidanaCount >= 4 ? 'Moderate' : 'Low'}
   
   Risk Factors Identified:
${getNidanaDetails()}

4. CLINICAL EXAMINATION:
   - Tests Completed: ${getExaminationSummary()}
   - Key Findings: ${getKeyFindings()}
   
   Detailed Examination Results:
${getExaminationDetails()}

5. INVESTIGATION SUMMARY:
   - Total Files Uploaded: ${getTotalFilesUploaded()}
   - Investigation Categories: ${getInvestigationCategories()}
   - Investigation Notes: ${investigationNotes || 'None provided'}

=====================================
TREATMENT RECOMMENDATIONS:
=====================================
${getDetailedRecommendations(diagnosis, severity, nidanaCount)}

=====================================
FOLLOW-UP PLAN:
=====================================
${getFollowUpPlan(severity)}

=====================================
DISCLAIMER:
=====================================
This assessment is based on traditional Ayurvedic diagnostic principles 
and should be used in conjunction with modern clinical evaluation.
The recommendations provided are general guidelines and should be 
personalized based on individual patient conditions and expert consultation.

Report Generated by: Gridhrasi Assessment Scale v1.0
EVA College of Ayurved Digital Assessment Tool
            `;

            // Create downloadable report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Gridhrasi_Report_${patientData.personalInfo.patientName || 'Patient'}_${currentDate.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Comprehensive assessment report has been generated and downloaded!');
        }
        */

        function getNidanaDetails() {
            const identifiedFactors = [];
            Object.keys(patientData.nidana).forEach(index => {
                if (nidanaFactors[index]) {
                    identifiedFactors.push(`   - ${nidanaFactors[index].title}`);
                }
            });
            return identifiedFactors.length > 0 ? identifiedFactors.join('\n') : '   - None identified';
        }

        function getExaminationDetails() {
            const details = [];
            examinationTests.forEach(test => {
                const exam = patientData.examination[test.id];
                if (exam && exam.result) {
                    details.push(`   - ${test.title}: ${exam.result}`);
                    if (exam.notes) {
                        details.push(`     Notes: ${exam.notes}`);
                    }
                }
            });
            return details.length > 0 ? details.join('\n') : '   - No examination results recorded';
        }

        function getDetailedRecommendations(diagnosis, severity, nidanaCount) {
            let recommendations = [];

            // Treatment recommendations based on diagnosis
            if (diagnosis.includes('Vataja')) {
                recommendations.push('VATAJA GRIDHRASI TREATMENT PROTOCOL:');
                recommendations.push('- Primary Focus: Snehana (oleation) and Swedana (sudation)');
                recommendations.push('- Panchakarma Therapies: Abhyanga, Karna Purana, Basti Chikitsa');
                recommendations.push('- Medications: Vata-pacifying formulations like Mahanarayana Taila');
                recommendations.push('- Diet: Warm, unctuous, easily digestible food');
                recommendations.push('- Lifestyle: Regular oil massage, warm compresses');
            } else if (diagnosis.includes('Vata-Kaphaja')) {
                recommendations.push('VATA-KAPHAJA GRIDHRASI TREATMENT PROTOCOL:');
                recommendations.push('- Initial Phase: Deepana-Pachana (digestive fire enhancement)');
                recommendations.push('- Secondary Phase: Snehana-Swedana after Ama pacification');
                recommendations.push('- Therapies: Ruksha Swedana initially, then Snigdha Swedana');
                recommendations.push('- Medications: Kapha-Vata pacifying formulations');
                recommendations.push('- Diet: Light, warm, spicy food initially');
            } else {
                recommendations.push('MIXED PRESENTATION TREATMENT:');
                recommendations.push('- Individualized approach based on predominant dosha');
                recommendations.push('- Sequential treatment protocols');
                recommendations.push('- Regular monitoring and adjustment of treatment');
            }

            recommendations.push('');

            // Severity-based recommendations
            if (severity === 'Severe Gridhrasi') {
                recommendations.push('SEVERITY-SPECIFIC RECOMMENDATIONS (SEVERE):');
                recommendations.push('- Immediate specialized Ayurvedic consultation required');
                recommendations.push('- Consider intensive Panchakarma therapy');
                recommendations.push('- Strict bed rest and activity modification');
                recommendations.push('- Pain management with appropriate medications');
                recommendations.push('- Daily monitoring and assessment');
            } else if (severity === 'Moderate Gridhrasi') {
                recommendations.push('SEVERITY-SPECIFIC RECOMMENDATIONS (MODERATE):');
                recommendations.push('- Regular Ayurvedic consultation (weekly initially)');
                recommendations.push('- Outpatient Panchakarma procedures');
                recommendations.push('- Lifestyle modifications and therapeutic interventions');
                recommendations.push('- Physical therapy and yoga as appropriate');
            } else if (severity === 'Mild Gridhrasi') {
                recommendations.push('SEVERITY-SPECIFIC RECOMMENDATIONS (MILD):');
                recommendations.push('- Preventive care and lifestyle counseling');
                recommendations.push('- Home-based therapeutic measures');
                recommendations.push('- Regular follow-up assessments');
                recommendations.push('- Emphasis on Nidana Parivarjana (avoiding causative factors)');
            }

            recommendations.push('');

            // Risk factor management
            if (nidanaCount >= 6) {
                recommendations.push('RISK FACTOR MANAGEMENT (HIGH PRIORITY):');
                recommendations.push('- Comprehensive lifestyle modification program');
                recommendations.push('- Ergonomic assessment and workplace modifications');
                recommendations.push('- Stress management and relaxation techniques');
                recommendations.push('- Dietary counseling and meal planning');
                recommendations.push('- Exercise prescription and physical conditioning');
            }

            return recommendations.join('\n');
        }

        function getFollowUpPlan(severity) {
            let plan = [];
            
            if (severity === 'Severe Gridhrasi') {
                plan.push('- Daily assessment for first week');
                plan.push('- Weekly follow-up for first month');
                plan.push('- Bi-weekly follow-up for next 2 months');
                plan.push('- Monthly follow-up thereafter');
            } else if (severity === 'Moderate Gridhrasi') {
                plan.push('- Weekly follow-up for first month');
                plan.push('- Bi-weekly follow-up for next month');
                plan.push('- Monthly follow-up for 3 months');
            } else {
                plan.push('- Monthly follow-up for 2 months');
                plan.push('- Quarterly follow-up thereafter');
            }
            
            plan.push('- Re-assessment using this scale at each visit');
            plan.push('- Patient education on warning signs');
            plan.push('- Emergency contact protocol');
            
            return plan.join('\n');
        }

        function exportAllData() {
            savePatientInfo();
            const investigationNotes = document.getElementById('investigationNotes').value;
            patientData.investigations.notes = investigationNotes;

            const exportData = {
                timestamp: new Date().toISOString(),
                patientData: patientData,
                calculatedScores: {
                    symptomScore: Object.values(patientData.symptoms).reduce((sum, score) => sum + score, 0),
                    nidanaCount: Object.keys(patientData.nidana).length,
                    differentialScores: calculateDifferentialScores()
                },
                assessmentSummary: {
                    examinationSummary: getExaminationSummary(),
                    keyFindings: getKeyFindings(),
                    totalFiles: getTotalFilesUploaded(),
                    investigationCategories: getInvestigationCategories()
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Gridhrasi_Data_${patientData.personalInfo.patientName || 'Patient'}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Complete assessment data has been exported successfully!');
        }

        function calculateDifferentialScores() {
            let vatajaScore = 0;
            let vataKaphajaScore = 0;
            Object.values(patientData.differential).forEach(value => {
                if (value === 'vataja') vatajaScore += 2;
                else if (value === 'vataKaphaja') vataKaphajaScore += 2;
                else if (value === 'both') { vatajaScore += 1; vataKaphajaScore += 1; }
            });
            return { vatajaScore, vataKaphajaScore };
        }

        function printResults() {
            window.print();
        }

        function resetAllAssessments() {
            if (confirm('Are you sure you want to reset ALL assessments and patient data? This action cannot be undone.')) {
                patientData = {
                    personalInfo: {},
                    nidana: {},
                    symptoms: {},
                    differential: {},
                    examination: {},
                    investigations: {
                        files: {},
                        notes: ''
                    }
                };
                
                // Reset all form elements
                document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="tel"], select, textarea').forEach(input => {
                    input.value = '';
                });
                
                document.querySelectorAll('input[type="radio"]').forEach(input => {
                    input.checked = false;
                    input.closest('.radio-option').classList.remove('selected');
                });
                
                document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                    input.checked = false;
                    input.closest('.nidana-item').classList.remove('checked');
                });
                
                // Clear file uploads
                document.querySelectorAll('[id$="Files"]').forEach(container => {
                    container.innerHTML = '';
                });
                
                // Reset displays
                document.getElementById('totalScore').textContent = '0';
                document.getElementById('symptomScore').textContent = '0';
                document.getElementById('nidanaCount').textContent = '0';
                document.getElementById('symptomProgress').style.width = '0%';
                document.getElementById('nidanaProgress').style.width = '0%';
                document.getElementById('differentialResult').innerHTML = '';
                document.getElementById('symptomSeverity').innerHTML = '';
                document.getElementById('finalResults').innerHTML = '';
                
                // Set default consultation date to today
                document.getElementById('consultationDate').value = new Date().toISOString().split('T')[0];
                
                // Go back to first page
                showTab('patient-info');
                
                alert('All assessments and patient data have been reset successfully!');
            }
        }
                // Auto-update scores
        setInterval(() => {
            updateScores();
        }, 1000);

        async function exportFullPDF() {
            savePatientInfo();
            updateFinalResults();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt", format: "a4" });

            const lineGap = 16;
            let y = 40;

            function addLine(text, bold = false) {
                if (bold) doc.setFont("helvetica", "bold");
                else doc.setFont("helvetica", "normal");

                doc.text(text, 40, y);
                y += lineGap;

                // Handle page breaks
                if (y > 780) {
                    doc.addPage();
                    y = 40;
                }
            }

            // Title
            doc.setFontSize(16);
            doc.text("Gridhrasi Assessment Report", 200, 30);
            doc.setFontSize(12);

            // === Patient Info ===
            addLine("=== Patient Information ===", true);
            for (const [key, value] of Object.entries(patientData.personalInfo)) {
                addLine(`${key}: ${value || 'Not specified'}`);
            }

            // === Nidana ===
            addLine("", false);
            addLine("=== Nidana (Etiological Factors) ===", true);
            const nidanaSelected = Object.keys(patientData.nidana).map(i => nidanaFactors[i].title);
            addLine("Selected: " + (nidanaSelected.length ? nidanaSelected.join(", ") : "None"));

            // === Symptoms ===
            addLine("", false);
            addLine("=== Symptom Assessment ===", true);
            const totalScore = Object.values(patientData.symptoms).reduce((sum, s) => sum + s, 0);
            addLine(`Total Symptom Score: ${totalScore}/36`);

            // === Differential Diagnosis ===
            addLine("", false);
            addLine("=== Differential Diagnosis ===", true);
            addLine(document.getElementById("differentialResult")?.innerText || "Not assessed");

            // === Examination Findings ===
            addLine("", false);
            addLine("=== Examination Findings ===", true);
            addLine(getKeyFindings());

            // === Investigations ===
            addLine("", false);
            addLine("=== Investigations ===", true);
            addLine(`Notes: ${patientData.investigations.notes || "None"}`);
            const files = [];
            Object.entries(patientData.investigations.files).forEach(([key, arr]) => {
                arr.forEach(f => files.push(f.name));
            });
            addLine("Files: " + (files.length ? files.join(", ") : "None"));

            // === Clinical Summary ===
            addLine("", false);
            addLine("=== Clinical Summary ===", true);
            addLine(document.getElementById("finalResults")?.innerText || "Summary not available");

            // Save PDF
            const safeName = (patientData.personalInfo.patientName || 'Patient').replace(/[^a-z0-9]/gi, '_');
            const fileName = `Gridhrasi_Full_Report_${safeName}_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);

        
    </script>
</body>
</html>
